#!/bin/bash
# Run OpenCode in a bubblewrap sandbox, preventing unnecessary file system access
# read only binding sensitive credential files to /dev/null masks them in the sandbox

PROJECT_DIR=$(pwd)
PARAMS=$@

echo "Project dir: $PROJECT_DIR"
echo "OpenCode args: $PARAMS"

bwrap \
     --ro-bind /usr /usr \
     --ro-bind /lib /lib \
     --ro-bind /lib64 /lib64 \
     --ro-bind /bin /bin \
     --ro-bind /etc/resolv.conf /etc/resolv.conf \
     --ro-bind /etc/hosts /etc/hosts \
     --ro-bind /etc/ssl /etc/ssl \
     --ro-bind /etc/passwd /etc/passwd \
     --ro-bind /etc/group /etc/group \
     --ro-bind-try "$HOME/dotfiles/stow/" "$HOME/dotfiles/stow/" \
     --ro-bind-try "$HOME/.config/git/config" "$HOME/.config/git/config" \
     --ro-bind-try "$HOME/.config/git/config.local" "$HOME/.config/git/config.local" \
     --ro-bind-try "$HOME/.config/uv" "$HOME/.config/uv" \
     --ro-bind-try "$HOME/.local/share/uv" "$HOME/.local/share/uv" \
     --ro-bind-try "$HOME/.local/bin" "$HOME/.local/bin" \
     --ro-bind-try "$HOME/.nvm" "$HOME/.nvm" \
     --ro-bind-try "$HOME/.npmrc" "$HOME/.npmrc" \
     --ro-bind-try "$HOME/.cargo/bin" "$HOME/.cargo/bin" \
     --ro-bind-try "$HOME/.bashrc" "$HOME/.bashrc" \
     --ro-bind-try "$HOME/.zshrc" "$HOME/.zshrc" \
     --ro-bind-try "$HOME/.zshrc.local" "$HOME/.zshrc.local" \
     --ro-bind-try "$HOME/.zsh" "$HOME/.zsh" \
     --ro-bind-try "$HOME/.config/gh" "$HOME/.config/gh" \
     --ro-bind-try "$HOME/.claude/skills" "$HOME/.claude/skills" \
     --ro-bind-try "/run/user/1000/fnm_multishells" "/run/user/1000/fnm_multishells" \
     --ro-bind-try "$HOME/.local/share/fnm" "$HOME/.local/share/fnm" \
     --bind "$PROJECT_DIR" "$PROJECT_DIR" \
     --bind-try "$HOME/.cache/uv" "$HOME/.cache/uv" \
     --bind-try "$HOME/.cache/pip" "$HOME/.cache/pip" \
     --bind-try "$HOME/.cache/Microsoft" "$HOME/.cache/Microsoft" \
     --bind-try "$HOME/.cache/gh" "$HOME/.cache/gh" \
     --bind-try "$HOME/.npm" "$HOME/.npm" \
     --bind-try "/run/user/1000/fnm_multishells" "/run/user/1000/fnm_multishells" \
     --bind-try "$HOME/.local/share/fnm" "$HOME/.local/share/fnm" \
     --bind-try "$HOME/.opencode" "$HOME/.opencode" \
     --bind-try "$HOME/.local/share/opencode" "$HOME/.local/share/opencode" \
     --bind-try "$HOME/.local/state/opencode" "$HOME/.local/state/opencode" \
     --bind-try "$HOME/.config/opencode" "$HOME/.config/opencode" \
     --bind-try "$HOME/.cache/opencode" "$HOME/.cache/opencode" \
     --tmpfs /tmp \
     --proc /proc \
     --dev /dev \
     --share-net \
     --unshare-pid \
     --die-with-parent \
     --chdir "$PROJECT_DIR" \
     --ro-bind /dev/null "$PROJECT_DIR/.env" \
     --ro-bind /dev/null "$PROJECT_DIR/.env.local" \
     opencode $PARAMS
