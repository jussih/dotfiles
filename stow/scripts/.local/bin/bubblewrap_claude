#!/bin/bash
# Run Claude Code in a bubblewrap sandbox, preventing unnecessary file system access
# read only binding sensitive credential files to /dev/null masks them in the sandbox

PROJECT_DIR=$(pwd)
PARAMS=$@

echo "Project dir: $PROJECT_DIR"
echo "Claude args: $PARAMS"

bwrap \
     --ro-bind /usr /usr \
     --ro-bind /lib /lib \
     --ro-bind /lib64 /lib64 \
     --ro-bind /bin /bin \
     --ro-bind /etc/resolv.conf /etc/resolv.conf \
     --ro-bind /etc/hosts /etc/hosts \
     --ro-bind /etc/ssl /etc/ssl \
     --ro-bind /etc/passwd /etc/passwd \
     --ro-bind /etc/group /etc/group \
     --ro-bind-try "$HOME/.config/git/config" "$HOME/.config/git/config" \
     --ro-bind-try "$HOME/.config/git/config.local" "$HOME/.config/git/config.local" \
     --ro-bind-try "$HOME/.local/bin" "$HOME/.local/bin" \
     --ro-bind-try "$HOME/.nvm" "$HOME/.nvm" \
     --bind "$PROJECT_DIR" "$PROJECT_DIR" \
     --bind-try "$HOME/.cache/uv" "$HOME/.cache/uv" \
     --bind-try "$HOME/.cache/pip" "$HOME/.cache/pip" \
     --bind-try "$HOME/.npm" "$HOME/.npm" \
     --bind-try "$HOME/.claude" "$HOME/.claude" \
     --bind-try "$HOME/.claude.json" "$HOME/.claude.json" \
     --bind-try "$HOME/.local/share/claude" "$HOME/.local/share/claude" \
     --tmpfs /tmp \
     --proc /proc \
     --dev /dev \
     --share-net \
     --unshare-pid \
     --die-with-parent \
     --chdir "$PROJECT_DIR" \
     --ro-bind /dev/null "$PROJECT_DIR/.env" \
     --ro-bind /dev/null "$PROJECT_DIR/.env.local" \
     claude $PARAMS
